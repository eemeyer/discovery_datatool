<config
  xmlns="http://transparensee.com/schema/datatool-config-4"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation=
    "http://transparensee.com/schema/datatool-config-4
     http://transparensee.com/schema/datatool-config-4.xsd">
  <!--
    Please see the Discovery Engine online documentation for complete details about configuring the Data Tool:
    https://transparensee.com/docs/discovery/current/html/data_integration/datatool.html
  -->
  <dataSources>
    <dataSource name="production-dataSource"
      jar="drivers/mysql-connector-java-5.1.10-bin.jar"
      class="com.mysql.jdbc.jdbc2.optional.MysqlDataSource">
      <url>jdbc:mysql://localhost/test</url>
      <user>test</user>
      <password>test</password>
    </dataSource>
  </dataSources>

  <profiles>
    <sqlProfile name="production-profile" dataSource="production-dataSource">
      <retrieveSql startColumn="start" endColumn="end">
        select last_run as start, CURRENT_TIMESTAMP as end
        from changeset_profile
        where name = :name
      </retrieveSql>
      <updateSql>
        update changeset_profile
        set last_run = :lastRun
        where name = :name
      </updateSql>
    </sqlProfile>
  </profiles>

  <publishers>
    <sqlPublisher name="production"
      dataSource="production-dataSource" profile="production-profile">
      <snapshot>
        <vertical-set-item idColumn="id" nameColumn="name" valueColumn="value" continguousIds="true">
          <query><![CDATA[
            SELECT mid.id, name, value
            FROM my_items
            JOIN my_items_data mid on (id)
            ORDER BY mid.id, name
          ]]></query>
        </vertical-set-item>
      </snapshot>
      <delta>
        <vertical-set-item idColumn="id" nameColumn="name" valueColumn="value" continguousIds="true">
          <query><![CDATA[
            SELECT mid.id, name, value
            FROM my_items
            JOIN my_items_data mid on (id)
            ORDER BY mid.id, name
            WHERE timestamp >= :start and timestamp < :end
          ]]></query>
        </vertical-set-item>
        <remove-item idColumn="id">
          <query><![CDATA[
            select id from deleted_items
            where last_updated >= :start and last_updated < :end
          ]]></query>
        </remove-item>
      </delta>
    </sqlPublisher>

    <sqlPublisher name="production"
      dataSource="production-dataSource" profile="production-profile">
      <snapshot>
        <vertical-set-item idColumn="id" nameColumn="name" valueColumn="value">
          <query><![CDATA[
            SELECT mid.id, name, value
            FROM my_items
            JOIN my_items_data mid on (id)
            ORDER BY mid.id, name
          ]]></query>
          <subquery><![CDATA[
            select name as color from SubqueryColors where parent_id=:id order by name
          ]]></subquery>
        </vertical-set-item>
      </snapshot>
      <delta>
        <vertical-set-item idColumn="id" nameColumn="name" valueColumn="value">
          <query><![CDATA[
            SELECT mid.id, name, value
            FROM my_items
            JOIN my_items_data mid on (id)
            ORDER BY mid.id, name
            WHERE timestamp >= :start and timestamp < :end
          ]]></query>
          <subquery><![CDATA[
            select name as color from SubqueryColors where parent_id=:id order by name
          ]]></subquery>
        </vertical-set-item>
        <remove-item idColumn="id">
          <query><![CDATA[
            select id from deleted_items
            where last_updated >= :start and last_updated < :end
          ]]></query>
        </remove-item>
      </delta>
    </sqlPublisher>

    <sqlPublisher name="production"
      dataSource="production-dataSource" profile="production-profile">
      <snapshot>
        <vertical-add-to-item idColumn="id" nameColumn="name" valueColumn="value">
          <query><![CDATA[
            SELECT mid.id, name, value
            FROM my_items
            JOIN my_items_data mid on (id)
          ]]></query>
        </vertical-add-to-item>
      </snapshot>
      <delta>
        <vertical-add-to-item idColumn="id" nameColumn="name" valueColumn="value">
          <query><![CDATA[
            SELECT mid.id, name, value
            FROM my_items
            JOIN my_items_data mid on (id)
            WHERE timestamp >= :start and timestamp < :end
          ]]></query>
        </vertical-add-to-item>
        <remove-item idColumn="id">
          <query><![CDATA[
            select id from deleted_items
            where last_updated >= :start and last_updated < :end
          ]]></query>
        </remove-item>
      </delta>
    </sqlPublisher>

  </publishers>
</config>
